# DFT Plan: Thermodynamic Support for Na3SbS4 Recycling via Hydration-Dehydration

This plan provides DFT-based thermodynamic validation for closed-loop recycling of Na3SbS4 solid electrolyte through reversible hydration-dehydration chemistry. Calculations support experimental recycling work demonstrating recovery of high-performance Na3SbS4 from spent all-solid-state sodium batteries.

## Scope
- **Structures**: Na3SbS4 (anhydrous) and Na3SbS4·8H2O (representative hydrate, from Yaosen Tian et al., Joule 2019)
- **Methods**: VASP/PBE with dispersion corrections (D3), gas-phase chemical potential μ(T,p) for H2O
- **Focus**: Thermodynamic validation of recycling pathway, not interface chemistry

**Note**: The experimental work uses Na3SbS4·9H2O during recycling. We model Na3SbS4·8H2O as a representative hydrate since the thermodynamic trends (hydration favorability, dehydration conditions) are expected to be similar for n=8 or 9.

## Research Questions
This theoretical work addresses three key questions that experiments cannot directly answer:

1. **Is recycling thermodynamically reversible?**
   - Can Na3SbS4 hydrate spontaneously at ambient conditions?
   - Can the hydrate dehydrate back to Na3SbS4 under vacuum/heat?

2. **What are optimal dehydration conditions?**
   - What temperature is required for complete water removal?
   - How does vacuum lower the dehydration temperature?

3. **Does dehydration restore the Na+ conduction framework?**
   - Is the crystal structure fully recovered?
   - Are ionic transport pathways preserved?

## Deliverables

**Main Text Figures** (2 figures):
1. **Phase diagram**: ΔG vs (T, RH) showing stability regions and recycling pathway
2. **Dehydration mechanism**: ΔG(T) for stepwise water loss, ambient vs vacuum

**Supporting Information** (1 figure):
- Crystal structure comparison showing Na+ pathways before/after hydration

## Directory Map
- `10_structures/`: CIF inputs for Na3SbS4 and Na3SbS4·8H2O (copied from model/)
- `20_vasp_inputs/`: CIF→POSCAR converter, VASP input templates (INCAR, KPOINTS, POTCAR_MAP)
- `30_thermo/`: Hydration/dehydration reaction definitions, energy database, and ΔG calculator with μ(T,p,RH)
- `40_transport/`: (Optional) NEB scaffolding for Na+ migration barriers

## DFT Settings (recommended)
- **Code**: VASP 5.x or 6.x
- **Functional**: PBE with D3(BJ) dispersion correction (IVDW=12) for hydrates
- **PAW potentials**: Na (or Na_pv), Sb, S, O, H
- **Energy cutoff**: ENCUT=520 eV; PREC=Accurate; LASPH=.TRUE.
- **Electronic convergence**: EDIFF=1e-6 eV
- **Smearing**: ISMEAR=0 (Gaussian), SIGMA=0.05 eV
- **Relaxation**: IBRION=2, ISIF=3 (relax cell + ions), NSW=100, EDIFFG=-0.02 eV/Å
- **Static**: NSW=0 (single-point energy on relaxed structure)
- **K-mesh**: Gamma-centered, ~0.2 Å⁻¹ spacing (auto-generated by prepare_inputs.py)

## Thermodynamic Approach

### Hydration/Dehydration Reactions
**Hydration** (dissolution step in recycling):
```
Na3SbS4 (s) + 8 H2O (g) ⇌ Na3SbS4·8H2O (s)
```

**Dehydration** (thermal regeneration step):
```
Na3SbS4·8H2O (s) → Na3SbS4 (s) + 8 H2O (g)
```

### Free Energy Calculation
- **Solids**: DFT total energies E_DFT(T≈0K) from static calculations
  - At finite T: G_solid(T) ≈ E_DFT + ZPE (zero-point energy, optional)
  - Neglect vibrational entropy for solids (small contribution)

- **Water vapor**: Chemical potential μ_H2O(T, p) = μ°(T) + RT ln(p/p°)
  - μ°(T) from Shomate equations (NIST data, 298-1000 K)
  - p from relative humidity: p_H2O = RH × p_sat(T)
  - p_sat(T) from Antoine or Wagner equation

- **Reaction free energy**:
  ```
  ΔG_rxn(T, RH) = [G_products - G_reactants]
                = [E_solid,products - E_solid,reactants] + n × μ_H2O(T, RH)
  ```

### Inputs
- `30_thermo/energies.yaml`: DFT total energies (eV per formula unit)
- `30_thermo/reactions.yaml`: Stoichiometry of hydration/dehydration reactions
- `30_thermo/utils_thermo.py`: Shomate equations, RH ↔ p_H2O conversions

## Workflow Overview
1. **Structure preparation**: Generate VASP inputs for Na3SbS4 and Na3SbS4·8H2O
2. **DFT calculations**: Relax → static for both structures
3. **Energy extraction**: Collect total energies from OUTCAR files
4. **Thermodynamic analysis**:
   - Calculate ΔG(T, RH) for hydration/dehydration
   - Generate phase diagrams showing stability regions
   - Map experimental recycling conditions onto the diagram
5. **(Optional) Transport**: NEB for Na+ migration barriers to support conductivity interpretation

---

## Detailed Implementation Plan

### Phase 1: Structure Preparation

#### 1.1 Required Structures
**Only two structures are needed for hydration/dehydration thermodynamics:**

- ✅ **Na3SbS4** (anhydrous) - CIF available in `10_structures/Na3SbS4.cif`
- ✅ **Na3SbS4·8H2O** (hydrate) - CIF available in `10_structures/Na3SbS4_yaosen.cif`

**Note**: These structures are already available (copied from `model/` directory). No additional structure building is needed.

#### 1.2 Generate VASP Inputs
If not already done, prepare VASP input directories:

```bash
cd calculation/20_vasp_inputs

# Anhydrous Na3SbS4
python3 prepare_inputs.py --cif ../10_structures/Na3SbS4.cif --out Na3SbS4

# Hydrated Na3SbS4·8H2O
python3 prepare_inputs.py --cif ../10_structures/Na3SbS4_yaosen.cif --out Na3SbS4_8H2O
```

This creates subdirectories:
- `Na3SbS4/relax/` and `Na3SbS4/static/`
- `Na3SbS4_8H2O/relax/` and `Na3SbS4_8H2O/static/`

Each contains: POSCAR, KPOINTS, INCAR (from templates), and POTCAR (auto-generated)

#### 1.3 POTCAR Verification
Before submitting jobs, verify POTCAR files exist:
```bash
ls 20_vasp_inputs/Na3SbS4/relax/POTCAR
ls 20_vasp_inputs/Na3SbS4/static/POTCAR
ls 20_vasp_inputs/Na3SbS4_8H2O/relax/POTCAR
ls 20_vasp_inputs/Na3SbS4_8H2O/static/POTCAR
```

**Required PAW potentials**: Na (or Na_pv), Sb, S, O, H

**Important**: Set `VASP_PSP_DIR` environment variable to your VASP pseudopotential library root (see `POTCAR_MAP.txt`)

---

### Phase 2: VASP Calculations

**Critical**: Always run relaxation before static calculations. The static calculation uses the relaxed geometry (CONTCAR → POSCAR).

#### 2.1 Calculation Sequence

**Step 1: Submit Relaxation Jobs**
```bash
cd calculation/20_vasp_inputs/Na3SbS4/relax
sbatch submit.sh  # or your cluster's job submission command

cd ../../../calculation/20_vasp_inputs/Na3SbS4_8H2O/relax
sbatch submit.sh
```

**Expected runtime**: 12-24 hours per structure on 32 cores (depending on system size)

**Step 2: Monitor Convergence**
Check `OSZICAR` for convergence:
```bash
tail -n 20 OSZICAR
```

Look for:
- Energy convergence: `dE < 1e-6 eV` between ionic steps
- Force convergence: `RMS force < 0.02 eV/Å`
- Final line should show `reached required accuracy`

**Step 3: Run Static Calculations**
After relaxation converges, copy relaxed structure and run single-point energy:
```bash
cd calculation/20_vasp_inputs/Na3SbS4/static
cp ../relax/CONTCAR POSCAR
sbatch submit.sh

cd ../../../calculation/20_vasp_inputs/Na3SbS4_8H2O/static
cp ../relax/CONTCAR POSCAR
sbatch submit.sh
```

**Expected runtime**: 1-3 hours per structure

#### 2.2 Troubleshooting

**If relaxation doesn't converge after 100 steps**:
- Check OSZICAR: Is energy oscillating or decreasing?
- Increase NSW to 200 in INCAR
- For hydrate: Ensure D3 dispersion is enabled (IVDW=12)

**If static calculation fails**:
- Verify CONTCAR from relax is valid (not truncated)
- Check that INCAR has NSW=0

#### 2.3 Computational Resources
- **Account**: purewater
- **Partition**: tier3
- **Nodes**: 1 node, 32 CPUs
- **Memory**: 500 MB per CPU (~16 GB total)
- **Time limit**: 48 hours (relax), 4 hours (static)
- **VASP binary**: `vasp_std` (loaded via spack)

---

### Phase 3: Energy Extraction

#### 3.1 Extract Total Energies from OUTCAR
After both static calculations complete, extract DFT total energies:

**Method 1: Manual extraction**
```bash
cd calculation/20_vasp_inputs/Na3SbS4/static
grep "free  energy   TOTEN" OUTCAR | tail -1

cd ../../../calculation/20_vasp_inputs/Na3SbS4_8H2O/static
grep "free  energy   TOTEN" OUTCAR | tail -1
```

This gives total energy in eV (for the entire unit cell).

**Method 2: Using parse script** (if available)
```bash
cd calculation/30_thermo
python3 parse_energy.py --path ../20_vasp_inputs/Na3SbS4/static
python3 parse_energy.py --path ../20_vasp_inputs/Na3SbS4_8H2O/static
```

#### 3.2 Create energies.yaml
Populate `30_thermo/energies.yaml` with extracted values:

```yaml
# DFT total energies (eV per formula unit)
# Extracted from static/OUTCAR (free energy TOTEN)
# Format: compound_name: energy_value

Na3SbS4: -XX.XXXX      # Replace with your calculated value
Na3SbS4_8H2O: -YY.YYYY # Replace with your calculated value
```

**Important notes**:
- Use "free energy TOTEN" from OUTCAR (includes entropy at SIGMA temperature)
- Energy should be per formula unit (Na3SbS4, not per atom)
- If your cell contains multiple formula units, divide by the number of f.u.
- Example: If OUTCAR shows `-234.567 eV` for a cell with 2 f.u. of Na3SbS4, use `-117.284 eV`

---

### Phase 4: Thermodynamic Analysis

This phase addresses the three key research questions outlined in the scope.

#### 4.1 Define Hydration/Dehydration Reaction
Edit `30_thermo/reactions.yaml` to include:
```yaml
hydration:
  reactants:
    Na3SbS4: 1
    H2O_gas: 8
  products:
    Na3SbS4_8H2O: 1
  description: "Hydration of Na3SbS4 (dissolution step in recycling)"

dehydration:
  reactants:
    Na3SbS4_8H2O: 1
  products:
    Na3SbS4: 1
    H2O_gas: 8
  description: "Dehydration of hydrate (regeneration step)"
```

#### 4.2 Single-Point Test Calculation
Test the calculation at specific conditions:
```bash
cd calculation/30_thermo

# Example: Room temperature, high RH (ambient hydration)
python3 compute_reaction_energies.py \
  --energies energies.yaml \
  --reactions reactions.yaml \
  --T 298 \
  --RH 0.80

# Example: Dehydration conditions (vacuum thermal treatment)
python3 compute_reaction_energies.py \
  --energies energies.yaml \
  --reactions reactions.yaml \
  --T 523 \
  --p_H2O 1e-6  # vacuum: ~10^-6 bar
```

**Expected output**: ΔE and ΔG for hydration/dehydration reactions

#### 4.3 Generate Phase Diagram
Sweep temperature and humidity to map stability regions:

```bash
cd calculation/30_thermo

# Create sweep script
cat > sweep_phase_diagram.sh <<'EOF'
#!/bin/bash
# Sweep T and RH for phase diagram

echo "T_K,RH,p_H2O_bar,deltaG_hydration_eV" > phase_diagram.csv

# Ambient pressure sweep (RH = 0 to 100%)
for T in 298 323 348 373 398 423; do
  for RH in $(seq 0 0.05 1.0); do
    python3 compute_reaction_energies.py \
      --energies energies.yaml \
      --reactions reactions.yaml \
      --T $T --RH $RH >> phase_diagram.csv
  done
done

# Vacuum dehydration sweep (high T, low p_H2O)
for T in 373 423 473 523 573 623; do
  for p_H2O in 1e-8 1e-7 1e-6 1e-5 1e-4 1e-3 1e-2; do
    python3 compute_reaction_energies.py \
      --energies energies.yaml \
      --reactions reactions.yaml \
      --T $T --p_H2O $p_H2O >> phase_diagram.csv
  done
done
EOF

chmod +x sweep_phase_diagram.sh
./sweep_phase_diagram.sh
```

#### 4.4 Key Questions to Answer

**Question 1: Is recycling thermodynamically reversible?**
- Plot ΔG_hydration vs RH at T=298K
  - If ΔG < 0 at high RH (60-80%), hydration is spontaneous → validates dissolution step
- Plot ΔG_dehydration vs T at vacuum (p_H2O ~ 10⁻⁶ bar)
  - If ΔG < 0 at T > 250°C, dehydration is favorable → validates regeneration step

**Question 2: What are optimal dehydration conditions?**
- Determine T_critical where ΔG_dehydration = 0 at different water pressures
- Compare ambient (p_H2O ~ 0.03 bar) vs vacuum (p_H2O ~ 10⁻⁶ bar)
- Show that vacuum lowers required temperature by hundreds of degrees

**Question 3: Does structure recover after dehydration?**
- Compare relaxed crystal structures (CONTCAR files)
- Visualize Na+ conduction pathways in both structures
- Calculate unit cell volume change: ΔV = (V_hydrate - V_anhydrous) / V_anhydrous

---

### Phase 5 (Optional): Na+ Migration Barriers

**Purpose**: Provide theoretical support for the observation that recycled NAS maintains comparable ionic conductivity to pristine material.

**Note**: This is **optional** and **low priority**. The main story (thermodynamic validation of recycling) does not require NEB calculations. Only pursue if:
1. Phases 1-4 are complete and successful
2. Experimentalists specifically request migration barrier data
3. You have computational resources available

#### 5.1 Simplified Approach
Instead of full NEB calculations, consider:

**Option 1: Structural comparison**
- Visualize Na+ sites and pathways in relaxed structures
- Measure Na-Na distances along conduction pathways
- Qualitatively argue that dehydration restores the pathway geometry

**Option 2: Minimal NEB calculation**
- Identify one representative Na1→Na2 hop in Na3SbS4
- Run single NEB calculation (5 images) for the pristine structure
- Compare to literature values (expected ~200-400 meV)
- Note in manuscript: "Migration barrier comparable to literature, consistent with recovered conductivity"

#### 5.2 If You Decide to Run NEB
Use the existing NEB scaffolding in `40_transport/`:
```bash
cd calculation/40_transport
python3 make_neb.py --out neb_Na3SbS4 --images 5
# Follow template in neb_template/README.txt
```

**Expected computational cost**: 48-72 hours on 32 cores for a supercell calculation

**References for comparison**:
- Tian et al. (Joule 2019): Na+ barriers in Na3SbS4 hydrates
- Original Na3SbS4 papers: barriers in anhydrous phase

---

## Implementation Checklist

### Phase 1: Structure Preparation
- [x] Na3SbS4 CIF available in `10_structures/`
- [x] Na3SbS4·8H2O CIF available in `10_structures/`
- [ ] VASP inputs generated for both structures
- [ ] POTCAR files verified in all directories

### Phase 2: VASP Calculations
- [ ] Na3SbS4 relaxation submitted
- [ ] Na3SbS4 relaxation converged
- [ ] Na3SbS4 static calculation complete
- [ ] Na3SbS4·8H2O relaxation submitted
- [ ] Na3SbS4·8H2O relaxation converged
- [ ] Na3SbS4·8H2O static calculation complete

### Phase 3: Energy Extraction
- [ ] Total energy extracted from Na3SbS4/static/OUTCAR
- [ ] Total energy extracted from Na3SbS4_8H2O/static/OUTCAR
- [ ] `energies.yaml` file created and populated

### Phase 4: Thermodynamic Analysis
- [ ] `reactions.yaml` configured for hydration/dehydration
- [ ] Single-point test calculations successful
- [ ] Temperature-RH sweep completed (ambient conditions)
- [ ] Temperature-vacuum sweep completed (dehydration)
- [ ] Phase diagram plotted (ΔG vs T, RH)
- [ ] Critical temperatures identified
- [ ] Experimental recycling conditions mapped onto diagram

### Phase 5 (Optional): Transport
- [ ] Crystal structures visualized and compared
- [ ] Na+ pathway geometries analyzed
- [ ] (Optional) NEB calculation performed

---

## Computational Resource Estimates

### Total Computational Cost
**Core calculations** (Phases 1-4 only):
- 2 structures × (1 relax + 1 static) = **4 VASP jobs**
- Estimated wall time: ~30-50 hours total on 32 cores
- Storage: ~1.2 GB (2 relaxations + 2 statics)

**Optional NEB** (Phase 5):
- 1 NEB calculation (supercell) ≈ 48-72 hours on 32 cores
- Storage: ~2-3 GB additional

### Individual Job Times (on 32 cores)
- **Na3SbS4 relax**: 12-24 hours (depends on cell size)
- **Na3SbS4 static**: 1-2 hours
- **Na3SbS4·8H2O relax**: 12-24 hours (hydrate is larger, may take longer)
- **Na3SbS4·8H2O static**: 1-3 hours

### Workflow Timeline
Assuming sequential submission:
- **Week 1**: Submit both relaxations, wait for convergence
- **Week 1-2**: Submit both statics after relaxations finish
- **Week 2**: Extract energies, run thermodynamic analysis
- **Week 2-3**: Generate figures, interpret results

**Total time to completion**: 2-3 weeks (mostly waiting for jobs)

---

## Expected Deliverables

### Main Text Figures

**Figure 1: Thermodynamic validation of recycling pathway**
- Panel A: ΔG_hydration vs RH at T = 298 K
  - Show hydration is favorable at high RH (validates dissolution step)
- Panel B: ΔG_dehydration vs T at different p_H2O
  - Compare ambient pressure vs vacuum
  - Show vacuum enables low-T dehydration (validates regeneration)
- Panel C: Phase diagram (T vs RH) with experimental recycling path overlaid

**Figure 2: Dehydration mechanism and optimal conditions**
- Panel A: ΔG vs T for stepwise water loss
- Panel B: Critical temperature vs water pressure
- Panel C: Explanation of why vacuum treatment lowers T_dehydration

### Supporting Information

**Figure S1: Crystal structure comparison**
- Na3SbS4 and Na3SbS4·8H2O structures side-by-side
- Highlight Na+ conduction pathways
- Show pathways are restored after dehydration

**Table S1: Calculated energies and thermodynamic parameters**
- DFT total energies (eV per f.u.)
- ΔH_hydration, ΔS_hydration
- Critical RH and temperature values

---

## Key Assumptions and Limitations

1. **Na3SbS4·8H2O as proxy for 9H2O**:
   - Experiments use 9H2O form, but we model 8H2O (from available CIF)
   - Thermodynamic trends (favorable hydration, reversible dehydration) expected to be similar
   - Quantitative ΔG values may differ by ~0.1-0.2 eV/f.u., but qualitative conclusions hold

2. **Harmonic approximation for solids**:
   - We use static DFT energies (T ≈ 0 K) for solids
   - Neglect vibrational entropy (ΔS_vib ≈ 0 for solids)
   - This is acceptable because water entropy dominates the thermodynamics

3. **Ideal gas for water vapor**:
   - μ_H2O(T, p) calculated using ideal gas + Shomate fits
   - Valid for low pressure range (ambient to vacuum)

4. **PBE functional limitations**:
   - Standard DFE-GGA, good for bulk energetics
   - D3 dispersion captures weak H-bonding in hydrate
   - Does not account for strong correlation effects (unlikely important here)

5. **No kinetic barriers**:
   - Thermodynamic analysis only (ΔG)
   - Does not address kinetics of hydration/dehydration
   - Experiments show process occurs on reasonable timescales → kinetics not limiting

---

## References

### Experimental Background
- Yaosen Tian et al., "Reactivity-Guided Interface Design in Na Metal Solid-State Batteries," *Joule* **3**, 1037–1050 (2019) — Original Na3SbS4·8H2O structure and properties
- Manuscript from collaborators (this work) — Experimental recycling demonstration

### Computational Methods
- Grimme et al., "A consistent and accurate ab initio parametrization of density functional dispersion correction (DFT-D) for the 94 elements H-Pu," *J. Chem. Phys.* **132**, 154104 (2010) — D3 dispersion correction
- Chase, "NIST-JANAF Thermochemical Tables" (1998) — Shomate coefficients for H2O(g)

### Related Theory on Na3SbS4
- Y.-T. Chen et al., "Unraveling the Nature of Degradation in Na3SbS4-Based Solid Electrolytes," *J. Electrochem. Soc.* **170**, 080521 (2023)
- Y. Zhu & Y. Mo, "Materials Design Principles for Air-Stable Alkali Superionic Conductors," *Angew. Chem. Int. Ed.* **59**, 17472–17476 (2020)
